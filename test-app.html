<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioID Face Authentication Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        h2 {
            color: #555;
            margin: 20px 0 15px 0;
            font-size: 1.5rem;
        }

        h3 {
            color: #666;
            margin: 15px 0 10px 0;
            font-size: 1.2rem;
        }

        p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 5px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .logout-button {
            background: #dc3545;
        }

        .logout-button:hover {
            background: #c82333;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .user-info {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .user-info p {
            margin: 8px 0;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .error h3 {
            color: #721c24;
            margin-bottom: 10px;
        }

        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
            border: 1px solid #dee2e6;
        }

        .info-box {
            background-color: #d1ecf1;
            border-left: 4px solid #0c5460;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .button-group {
                flex-direction: column;
            }

            .button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê BioID Face Authentication Test</h1>
        <p>This test page demonstrates the complete OIDC flow with token exchange and user info retrieval.</p>
        
        <div class="info-box">
            <strong>‚ö†Ô∏è CORS Configuration Required</strong>
            <br><br>
            This page exchanges the authorization code for tokens, which requires CORS configuration:
            <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                <li>Go to: <a href="http://localhost:8080/admin" target="_blank" style="color: #0c5460; font-weight: bold;">Admin Console</a></li>
                <li>Navigate to: <strong>Clients ‚Üí bioid-demo-client ‚Üí Settings</strong></li>
                <li>Scroll to <strong>"Web origins"</strong> field</li>
                <li>Add: <code style="background: white; padding: 2px 6px; border-radius: 3px;">http://localhost:3000</code> or <code style="background: white; padding: 2px 6px; border-radius: 3px;">+</code></li>
                <li>Click <strong>"Save"</strong> at the bottom</li>
                <li>Restart Keycloak: <code style="background: white; padding: 2px 6px; border-radius: 3px;">docker compose restart keycloak</code></li>
            </ol>
            <p style="margin-top: 10px;">
                <strong>Alternative:</strong> Use <a href="simple-test.html" style="color: #0c5460; font-weight: bold;">simple-test.html</a> which works without CORS configuration.
            </p>
        </div>
        
        <div id="loginSection">
            <h2>Login Test</h2>
            <p>Click the button below to start the authentication flow. You'll be redirected to Keycloak, where you can test your username/password + face authentication.</p>
            <button class="button" onclick="login()">Login with Face Authentication</button>
            
            <h3>Quick Links</h3>
            <p>You can also access these Keycloak pages directly:</p>
            <a href="http://localhost:8080/realms/bioid-demo/account" class="button" target="_blank">Account Management</a>
            <a href="http://localhost:8080/admin/master/console/#/bioid-demo" class="button" target="_blank">Admin Console</a>
        </div>

        <div id="userSection" style="display: none;">
            <h2>‚úÖ Authentication Successful!</h2>
            
            <div class="user-info">
                <h3>üë§ User Information</h3>
                <div id="userInfo"></div>
            </div>
            
            <div id="credentialInfo" style="background: #e7f3ff; border-left: 4px solid #0066cc; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>üîê Face Credentials</h3>
                <p style="color: #0c5460;">Your face credentials are managed by Keycloak and stored in BioID BWS.</p>
                <div id="credentialDetails"></div>
                <div id="enrolledImages" style="margin-top: 15px;"></div>
            </div>
            
            <h3>‚öôÔ∏è Account Management</h3>
            <p>Manage your account and face enrollment:</p>
            <div class="button-group">
                <a href="http://localhost:8080/realms/bioid-demo/account" class="button" target="_blank">
                    üë§ Account Management
                </a>
                <a href="http://localhost:8080/realms/bioid-demo/account/#/security/signingin" class="button" target="_blank">
                    üì∏ Face Enrollment
                </a>
            </div>
            
            <br>
            <button class="button logout-button" onclick="logout()">üö™ Logout</button>
        </div>

        <div id="loadingSection" style="display: none;">
            <div class="loading">
                <div class="spinner"></div>
                <p id="loadingText">Processing authentication...</p>
            </div>
        </div>

        <div id="errorSection" style="display: none;">
            <div class="error">
                <h3>‚ö†Ô∏è Authentication Error</h3>
                <div id="errorInfo"></div>
            </div>
            <div class="button-group">
                <button class="button" onclick="clearError()">Try Again</button>
                <button class="button" onclick="checkSetup()">Check Setup</button>
            </div>
        </div>

        <div id="tokenSection" style="display: none;">
            <h3>Access Token (for debugging):</h3>
            <pre id="tokenDisplay"></pre>
        </div>
    </div>

    <script>
        // Configuration
        const KEYCLOAK_URL = 'http://localhost:8080';
        const REALM = 'bioid-demo';
        const CLIENT_ID = 'bioid-demo-client';
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // Check for authentication result on page load
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');

            if (error) {
                showError(`${error}: ${errorDescription || 'Unknown error'}`);
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (code) {
                // Show loading while exchanging code
                showLoading('Exchanging authorization code for tokens...');
                // Exchange code for tokens
                exchangeCodeForTokens(code);
            } else {
                // Check if we have stored tokens
                const accessToken = localStorage.getItem('access_token');
                if (accessToken) {
                    showLoading('Validating session...');
                    validateAndShowUser(accessToken);
                }
            }
        };

        async function login() {
            // Generate PKCE parameters
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Store code verifier for later use
            localStorage.setItem('code_verifier', codeVerifier);

            // Build authorization URL
            const authUrl = new URL(`${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/auth`);
            authUrl.searchParams.set('client_id', CLIENT_ID);
            authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('scope', 'openid profile email');
            authUrl.searchParams.set('code_challenge', codeChallenge);
            authUrl.searchParams.set('code_challenge_method', 'S256');
            authUrl.searchParams.set('state', generateState());

            // Redirect to Keycloak
            window.location.href = authUrl.toString();
        }

        async function exchangeCodeForTokens(code) {
            try {
                const codeVerifier = localStorage.getItem('code_verifier');
                if (!codeVerifier) {
                    throw new Error('Code verifier not found. Please try logging in again.');
                }

                console.log('Exchanging authorization code for tokens...');
                console.log('Code:', code.substring(0, 20) + '...');
                console.log('Code verifier:', codeVerifier.substring(0, 20) + '...');

                const tokenUrl = `${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/token`;
                
                const params = new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: CLIENT_ID,
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier
                });

                console.log('Token URL:', tokenUrl);
                console.log('Request params:', params.toString());

                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params,
                    mode: 'cors',
                    credentials: 'include'
                });

                console.log('Token response status:', response.status);

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                        console.error('Token error response:', errorData);
                        throw new Error(`${errorData.error}: ${errorData.error_description || 'Token exchange failed'}`);
                    } catch (e) {
                        const textError = await response.text();
                        console.error('Token error (text):', textError);
                        throw new Error(`HTTP ${response.status}: ${textError || 'Token exchange failed'}`);
                    }
                }

                const tokens = await response.json();
                console.log('Tokens received successfully');
                
                // Store tokens
                localStorage.setItem('access_token', tokens.access_token);
                if (tokens.refresh_token) {
                    localStorage.setItem('refresh_token', tokens.refresh_token);
                }
                if (tokens.id_token) {
                    localStorage.setItem('id_token', tokens.id_token);
                }

                // Clean up
                localStorage.removeItem('code_verifier');
                window.history.replaceState({}, document.title, window.location.pathname);

                // Show user info
                validateAndShowUser(tokens.access_token);

            } catch (error) {
                console.error('Token exchange error:', error);
                
                // Provide more helpful error messages
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'CORS Error: Cannot connect to Keycloak. This usually means:\n\n' +
                        '1. Keycloak is not running (check: http://localhost:8080)\n' +
                        '2. Web Origins not configured in client settings\n' +
                        '3. Browser is blocking the request\n\n' +
                        'Fix: Go to Admin Console ‚Üí Clients ‚Üí bioid-demo-client ‚Üí Settings\n' +
                        'Add to "Web origins": http://localhost:3000 or +';
                } else if (error.message.includes('invalid_grant')) {
                    errorMessage = 'Invalid authorization code. This usually means:\n\n' +
                        '1. The code has already been used\n' +
                        '2. The code has expired\n' +
                        '3. The redirect URI doesn\'t match\n\n' +
                        'Try logging in again.';
                }
                
                showError(errorMessage);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function validateAndShowUser(accessToken) {
            try {
                const userInfoUrl = `${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/userinfo`;
                const response = await fetch(userInfoUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }

                const userInfo = await response.json();
                showUser(userInfo, accessToken);

            } catch (error) {
                showError(`User info error: ${error.message}`);
                localStorage.clear();
            }
        }

        async function showUser(userInfo, accessToken) {
            hideLoading();
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'block';

            const userInfoDiv = document.getElementById('userInfo');
            userInfoDiv.innerHTML = `
                <p><strong>Username:</strong> ${userInfo.preferred_username || 'N/A'}</p>
                <p><strong>Email:</strong> ${userInfo.email || 'N/A'}</p>
                <p><strong>Name:</strong> ${userInfo.given_name || ''} ${userInfo.family_name || ''}</p>
                <p><strong>User ID:</strong> ${userInfo.sub || 'N/A'}</p>
                <p><strong>Email Verified:</strong> ${userInfo.email_verified ? '‚úÖ Yes' : '‚ùå No'}</p>
            `;

            // Show credential information from token
            const credentialDetailsDiv = document.getElementById('credentialDetails');
            try {
                const tokenPayload = JSON.parse(atob(accessToken.split('.')[1]));
                
                const authTime = tokenPayload.auth_time ? new Date(tokenPayload.auth_time * 1000).toLocaleString() : 'N/A';
                const expTime = tokenPayload.exp ? new Date(tokenPayload.exp * 1000).toLocaleString() : 'N/A';
                const acr = tokenPayload.acr || 'N/A';
                
                credentialDetailsDiv.innerHTML = `
                    <p style="color: #0c5460; margin-top: 10px;"><strong>Authentication Details:</strong></p>
                    <p style="color: #0c5460;"><strong>Authenticated At:</strong> ${authTime}</p>
                    <p style="color: #0c5460;"><strong>Token Expires:</strong> ${expTime}</p>
                    <p style="color: #0c5460;"><strong>Authentication Context:</strong> ${acr}</p>
                `;
                
                // Show token for debugging
                const tokenDisplay = document.getElementById('tokenDisplay');
                tokenDisplay.textContent = JSON.stringify(tokenPayload, null, 2);
                document.getElementById('tokenSection').style.display = 'block';
            } catch (e) {
                console.error('Failed to decode token:', e);
                credentialDetailsDiv.innerHTML = `
                    <p style="color: #0c5460;">Unable to decode token information.</p>
                `;
            }

            // Fetch template status and enrolled images
            await loadTemplateStatus(accessToken);
        }

        async function loadTemplateStatus(accessToken) {
            const enrolledImagesDiv = document.getElementById('enrolledImages');
            
            try {
                enrolledImagesDiv.innerHTML = '<p style="color: #0c5460;"><em>Loading template status...</em></p>';
                
                const statusUrl = `${KEYCLOAK_URL}/realms/${REALM}/face-api/status`;
                console.log('Fetching template status from:', statusUrl);
                
                const response = await fetch(statusUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const status = await response.json();
                console.log('Template status:', status);

                if (!status.enrolled) {
                    enrolledImagesDiv.innerHTML = `
                        <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 5px;">
                            ‚ö†Ô∏è No face template enrolled. Please enroll your face in Account Management.
                        </p>
                    `;
                    return;
                }

                // Display template status
                let html = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: #155724; margin: 5px 0;"><strong>‚úÖ Template Status:</strong> Enrolled</p>
                        <p style="color: #155724; margin: 5px 0;"><strong>Class ID:</strong> ${status.classId}</p>
                        <p style="color: #155724; margin: 5px 0;"><strong>Enrolled At:</strong> ${status.enrolledAt ? new Date(status.enrolledAt).toLocaleString() : 'N/A'}</p>
                        <p style="color: #155724; margin: 5px 0;"><strong>Encoder Version:</strong> ${status.encoderVersion || 'N/A'}</p>
                        <p style="color: #155724; margin: 5px 0;"><strong>Feature Vectors:</strong> ${status.featureVectors || 0}</p>
                        <p style="color: #155724; margin: 5px 0;"><strong>Thumbnails Stored:</strong> ${status.thumbnailsStored || 0}</p>
                    </div>
                `;

                // Display enrolled images
                if (status.thumbnails && status.thumbnails.length > 0) {
                    html += `
                        <div style="margin-top: 15px;">
                            <p style="color: #0c5460; font-weight: bold;">üì∏ Enrolled Images:</p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                    `;
                    
                    status.thumbnails.forEach((thumb, index) => {
                        html += `
                            <div style="text-align: center;">
                                <img src="${thumb.image}" alt="Enrolled face ${index + 1}" 
                                     style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #0066cc;">
                                <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                    ${thumb.enrolledAt ? new Date(thumb.enrolledAt).toLocaleDateString() : 'N/A'}
                                </p>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }

                enrolledImagesDiv.innerHTML = html;

            } catch (error) {
                console.error('Failed to load template status:', error);
                enrolledImagesDiv.innerHTML = `
                    <p style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 5px;">
                        ‚ö†Ô∏è Failed to load template status: ${error.message}
                    </p>
                `;
            }
        }

        function showError(message) {
            hideLoading();
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('tokenSection').style.display = 'none';
            document.getElementById('errorInfo').textContent = message;
        }

        function clearError() {
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
        }

        async function checkSetup() {
            showLoading('Checking Keycloak configuration...');
            
            try {
                // Check if Keycloak is accessible
                const healthCheck = await fetch(`${KEYCLOAK_URL}/health/ready`, { mode: 'no-cors' });
                console.log('Keycloak health check completed');

                // Check if realm exists
                const realmCheck = await fetch(`${KEYCLOAK_URL}/realms/${REALM}/.well-known/openid-configuration`);
                if (!realmCheck.ok) {
                    throw new Error(`Realm '${REALM}' not found`);
                }

                const config = await realmCheck.json();
                console.log('Realm configuration:', config);

                hideLoading();
                
                const setupInfo = `
‚úÖ Setup Check Results:

Keycloak URL: ${KEYCLOAK_URL}
Realm: ${REALM}
Client ID: ${CLIENT_ID}
Redirect URI: ${REDIRECT_URI}

Authorization Endpoint: ${config.authorization_endpoint}
Token Endpoint: ${config.token_endpoint}

Common Issues:
1. Web Origins not configured
   ‚Üí Go to Admin Console ‚Üí Clients ‚Üí ${CLIENT_ID} ‚Üí Settings
   ‚Üí Add to "Web origins": ${window.location.origin} or +

2. Redirect URI not allowed
   ‚Üí Add to "Valid redirect URIs": ${REDIRECT_URI}

3. PKCE not enabled
   ‚Üí Go to Advanced tab
   ‚Üí Set "Proof Key for Code Exchange Code Challenge Method" to S256

4. Client authentication enabled (should be OFF for public clients)
   ‚Üí Go to Settings tab
   ‚Üí Set "Client authentication" to OFF
                `;

                alert(setupInfo);
                document.getElementById('loginSection').style.display = 'block';

            } catch (error) {
                hideLoading();
                showError(`Setup check failed: ${error.message}\n\nMake sure Keycloak is running at ${KEYCLOAK_URL}`);
            }
        }

        async function logout() {
            const idToken = localStorage.getItem('id_token');
            localStorage.clear();

            // Redirect to Keycloak logout
            const logoutUrl = new URL(`${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/logout`);
            logoutUrl.searchParams.set('post_logout_redirect_uri', REDIRECT_URI);
            if (idToken) {
                logoutUrl.searchParams.set('id_token_hint', idToken);
            }

            window.location.href = logoutUrl.toString();
        }

        // PKCE helper functions
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            return crypto.subtle.digest('SHA-256', data).then(hash => {
                return base64URLEncode(new Uint8Array(hash));
            });
        }

        function base64URLEncode(array) {
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function generateState() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        // Make generateCodeChallenge work with the synchronous flow
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(hash));
        }
    </script>
</body>
</html>