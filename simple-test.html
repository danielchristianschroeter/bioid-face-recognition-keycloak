<!DOCTYPE html>
<html>

<head>
    <title>Simple OIDC Test</title>
</head>

<body>
    <h1>Simple OIDC Test</h1>
    <p>Testing basic OIDC flow with PKCE:</p>

    <button onclick="testLogin()">Test Login (Force Fresh)</button>
    <button onclick="logout()"
        style="margin-left: 10px; background-color: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Logout
        First</button>

    <h3>Quick Links</h3>
    <p>Access Keycloak pages directly:</p>
    <a href="http://localhost:8080/realms/bioid-demo/account" target="_blank" 
       style="display: inline-block; background-color: #007bff; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin: 5px;">Account Management</a>
    <a href="http://localhost:8080/realms/bioid-demo/account/#/security/signingin" target="_blank"
       style="display: inline-block; background-color: #28a745; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin: 5px;">Face Enrollment</a>
    <a href="http://localhost:8080/admin/master/console/#/bioid-demo" target="_blank"
       style="display: inline-block; background-color: #6c757d; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin: 5px;">Admin Console</a>

    <div id="result"></div>

    <script>
        async function testLogin() {
            try {
                // Generate PKCE parameters
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);

                // Store code verifier for later use
                localStorage.setItem('code_verifier', codeVerifier);

                const authUrl = 'http://localhost:8080/realms/bioid-demo/protocol/openid-connect/auth' +
                    '?client_id=bioid-demo-client' +
                    '&redirect_uri=' + encodeURIComponent('http://localhost:3000/simple-test.html') +
                    '&response_type=code' +
                    '&scope=openid' +
                    '&code_challenge=' + encodeURIComponent(codeChallenge) +
                    '&code_challenge_method=S256' +
                    '&prompt=login'; // Force fresh login

                console.log('Code Verifier:', codeVerifier);
                console.log('Code Challenge:', codeChallenge);
                console.log('Redirecting to:', authUrl);

                window.location.href = authUrl;
            } catch (error) {
                console.error('Error generating PKCE parameters:', error);
                document.getElementById('result').innerHTML = '<p style="color: red;">❌ Error generating PKCE parameters: ' + error.message + '</p>';
            }
        }

        function logout() {
            // Clear any local storage
            localStorage.clear();

            // Redirect to Keycloak logout
            const logoutUrl = 'http://localhost:8080/realms/bioid-demo/protocol/openid-connect/logout' +
                '?post_logout_redirect_uri=' + encodeURIComponent('http://localhost:3000/simple-test.html');

            console.log('Logging out via:', logoutUrl);
            window.location.href = logoutUrl;
        }

        // PKCE helper functions
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(hash));
        }

        function base64URLEncode(array) {
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // Check for result
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');

        if (code) {
            document.getElementById('result').innerHTML = '<p style="color: green;">✅ Success! Got authorization code: ' + code.substring(0, 20) + '...</p>';
        } else if (error) {
            document.getElementById('result').innerHTML = '<p style="color: red;">❌ Error: ' + error + '<br>Description: ' + (errorDescription || 'None') + '</p>';
        }
    </script>
</body>

</html>